$LogPath = "C:\temp"

If (-not (Test-Path $LogPath)){New-Item $LogPath -ItemType Directory | Out-Null}

$Computers = Get-Content C:\Users\1392134782A\Desktop\Computers.txt

ForEach ($Computer in $Computers)
{
    "****************************************" | Out-File "$LogPath\servicesfix.log" -Append
    If (Test-Connection $Computer -Quiet -BufferSize 16 -Ea 0 -Count 1)
    {
        "Computer Name: $Computer connected..." | Out-File "$LogPath\servicesfix.log" -Append
        
        $RegPath = "SYSTEM\CurrentControlSet\Services\"
        $Reg = [microsoft.win32.registrykey]::OpenRemoteBaseKey('LocalMachine',$Computer)
        $RegKey = $Reg.OpenSubKey($RegPath)
        $SubKeys = $RegKey.GetSubKeyNames()
        $Results = @() 
        ForEach ($Key in $SubKeys) 
        { 
            $ThisKey = $RegPath+$Key 
            $ThisSubKey = $Reg.OpenSubKey($ThisKey) 
            $ImagePath = $ThisSubKey.GetValue("ImagePath") 
            $Remoteobj = [PSCustomObject] @{ 
                        ImagePath = $ThisSubKey.GetValue("ImagePath") 
                        } 
            $Results = $Remoteobj 
        }
        ForEach ($ImagePath in $Results)
        {
            If (($ImagePath -like "* *") -and ($ImagePath -notlike '"*"*') -and ($ImagePath -like '*.exe*'))
            { 
                $NewPath = ($ImagePath -split ".exe ")[0]
                $key1 = ($ImagePath -split ".exe ")[1]
                $triger = ($ImagePath -split ".exe ")[2]
    
                # Get all services with vulnerability with key in ImagePath
                If (-not ($triger | Measure-Object).count -ge 1)
                {
                    If (($NewPath -like "* *") -and ($NewPath -notlike "*.exe"))
                    {
        
                        "Old Value: $ImagePath" | Out-File "$LogPath\servicesfix.log" -Append
                        "New Value: `"$NewPath.exe`" $key1" | Out-File "$LogPath\servicesfix.log" -Append
                        "------------------------------" | Out-File "$LogPath\servicesfix.log" -Append 
                        Invoke-Command -ComputerName $Computer -ScriptBlock {Set-ItemProperty -Path "HKLM:\$($Args[0])" -Name "ImagePath" -Value "`"$($Args[1]).exe`" $($Args[2])"} -ArgumentList $ThisKey,$NewPath,$key1
                    }
                }

                # Get all services with vulnerability with out key in ImagePath
                If (-not ($triger | Measure-Object).count -ge 1)
                {
                    If (($NewPath -like "* *") -and ($NewPath -like "*.exe"))
                    {
        
                        "Old Value: $ImagePath" | Out-File "$LogPath\servicesfix.log" -Append
                        "New Value: `"$NewPath.exe`"" | Out-File "$LogPath\servicesfix.log" -Append
                        "------------------------------" | Out-File "$LogPath\servicesfix.log" -Append
                        Invoke-Command -ComputerName $Computer -ScriptBlock {Set-ItemProperty -Path "HKLM:\$($Args[0])" -Name "ImagePath" -Value "`"$($Args[1])`""} -ArgumentList $ThisKey,$NewPath
                    }
                }
                If (($triger | Measure-Object).count -ge 1)
                {
                    "----- Error Cant parse $ImagePath in registry" | Out-File $LogPath\servicesfix.log -Append
                }
            }
        }
    }
}